---
## Basic Service Setup ##
- name: Installing portal dependencies
  apt:
    name={{ item }}
    state=installed
  with_items:
     - nginx
     - php5
     - php5-fpm
     - conntrack
     - psmisc

- name: Disable Apache
  service:
    name=apache2
    state=stopped
  ignore_errors: yes

- name: Enable Nginx 
  service:
    name=nginx
    state=started

- name: PHP FPM should be running
  service:
    name=php5-fpm
    state=started


## Main Portal Pages ##
- name: Check out Project Rachel portal
  git: >
    repo=https://github.com/tunapanda/rachel-content
    dest={{ portal__site_content }}

- name: Link docroot to role site data (if needed)
  file:
    path={{ portal__docroot }}
    src={{ portal__site_content }}
    state=link
  when: portal__docroot != portal__site_content

- name: Install a host-specific landing page
  template:
    src=site/index.php
    dest={{ portal__docroot }}/index_meta.php

- name: Configure git to ignore the landing page
  lineinfile:
    dest={{ portal__docroot }}/.git/info/exclude
    line=index_meta.php
    state=present
    insertafter=EOF

- name: Set portal dir permissions
  file: 
    path={{ item }}
    state=directory
    owner=root group={{ common_web_user }} mode=775 
    recurse=true
  with_items:
    - "{{ portal__site_content }}"
    - "{{ portal__redirects }}"


## Nginx Setup ##
- name: Deploy site config
  template:
    src=nginx/portal.j2
    dest={{ portal__base }}/portal.conf
    owner=root group={{ common_web_user }} mode=0640

- name: Activate site config
  file:
    src={{ portal__base }}/portal.conf
    dest={{ provision__sites_enabled_dir }}/portal
    state=link owner=root group=root
  notify: reload nginx

- name: Remove nginx default page
  file:
    path={{ provision__sites_enabled_dir }}/default
    state=absent
  notify: reload nginx

- include: edx.yml
  when: edx__pre_installed is defined and edx__pre_installed


## Portal and Captive Auth Support Files ##
- name: Installing rmtrack script
  copy:
    src=rmtrack
    dest=/usr/bin/
    mode=0755

- include: captive.yml
  when: portal__auth is defined and portal__auth != "none"
  notify: reload iptables
