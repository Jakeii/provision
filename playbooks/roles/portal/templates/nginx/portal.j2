server {
  listen {{ portal__port|default("80") }} default;
  root {{ portal__docroot }};

  index index.php;

  server_name ~^(?<orig_host>.+)$;

  location / {
          return 301 http://$server_addr/index.php?orig_url=$host$request_uri$arg_PARAMETER;
  }
}

server {
  listen {{ portal__port|default("80") }};
  root {{ portal__docroot }};
  include "{{ portal__redirects }}/*";

  index index.html index.htm index.php;

  # Make site accessible from http://localhost/
  # Unfortunately, $server_addr is not working here
  server_name localhost $hostname {{ portal__redirect.ipv4.address }};

  location / {
          # First attempt to serve request as file, then
          # as directory, then fall back to internally
          # redirecting to the portal's home page.
          try_files $uri $uri/ /index.php;
          # Uncomment to enable naxsi on this location
          # include /etc/nginx/naxsi.rules
  }

  location ~ \.php$ {
         fastcgi_split_path_info ^(.+\.php)(/.+)$;
         # NOTE: You should have "cgi.fix_pathinfo = 0;" in php.ini
  
         # With php5-fpm:
         fastcgi_pass {{ php__fpm_url|default('127.0.0.1:9000') }};
         fastcgi_index index.php;
         include fastcgi_params;
  }
}
